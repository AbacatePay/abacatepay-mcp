name: CI - Verificações de Qualidade

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    name: ✅ Verificações Obrigatórias
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout do código
      uses: actions/checkout@v4

    - name: 🟢 Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 📦 Instalar dependências
      run: bun install

    - name: 🔍 Auditoria de segurança
      run: |
        echo "🔍 Verificando vulnerabilidades de segurança..."
        bun audit
        if [ $? -ne 0 ]; then
          echo "❌ Vulnerabilidades de alta severidade encontradas!"
          echo "💡 Execute 'bun audit' para verificar detalhes"
          exit 1
        fi
        echo "✅ Nenhuma vulnerabilidade crítica encontrada"

    - name: 🧹 Verificação de código (ESLint)
      run: |
        echo "🧹 Verificando qualidade do código..."
        bun run lint
        if [ $? -ne 0 ]; then
          echo "❌ Problemas de qualidade de código encontrados!"
          echo "💡 Execute 'bun run lint:fix' para corrigir automaticamente"
          exit 1
        fi
        echo "✅ Código está seguindo os padrões de qualidade"

    - name: 🔧 Verificação de tipos TypeScript
      run: |
        echo "🔧 Verificando tipos TypeScript..."
        bunx tsc --noEmit
        if [ $? -ne 0 ]; then
          echo "❌ Erros de tipo encontrados!"
          echo "💡 Corrija os erros de TypeScript antes de continuar"
          exit 1
        fi
        echo "✅ Todos os tipos estão corretos"

    - name: 🧪 Verificação do script inspector
      run: |
        echo "🧪 Testando script inspector..."
        if [ ! -f "scripts/inspector.js" ]; then
          echo "❌ Script inspector não encontrado!"
          exit 1
        fi
        
        # Verifica sintaxe do script
        bun scripts/inspector.js --help
        if [ $? -ne 0 ]; then
          echo "❌ Script inspector tem erros de sintaxe!"
          exit 1
        fi
        
        echo "✅ Script inspector está funcionando corretamente"

    - name: 🔍 Verificação de arquivos essenciais
      run: |
        echo "🔍 Verificando arquivos essenciais..."
        
        # Verifica se os arquivos TypeScript principais existem
        if [ ! -f "src/index.ts" ]; then
          echo "❌ Arquivo principal não encontrado!"
          exit 1
        fi
        
        # Verifica se o package.json tem os scripts necessários
        if ! grep -q '"start"' package.json || ! grep -q '"inspector"' package.json; then
          echo "❌ Scripts bun essenciais não encontrados!"
          echo "📋 Scripts necessários: start, inspector"
          exit 1
        fi
        
        echo "✅ Todos os arquivos essenciais estão presentes"

    - name: 🎯 Teste de importação do MCP Server
      run: |
        echo "🎯 Testando se o MCP Server pode ser executado..."
        bun run src/index.ts --help
        if [ $? -ne 0 ]; then
          echo "❌ Falha ao executar MCP Server!"
          exit 1
        fi
        echo "✅ MCP Server executado com sucesso"

    - name: 🎉 Sucesso
      run: |
        echo ""
        echo "🎉 Todas as verificações passaram com sucesso!"
        echo ""
        echo "📋 Resumo das verificações:"
        echo "  ✅ Dependências instaladas"
        echo "  ✅ Segurança verificada"
        echo "  ✅ Qualidade de código aprovada"
        echo "  ✅ Tipos TypeScript corretos"
        echo "  ✅ Script inspector funcional"
        echo "  ✅ Arquivos essenciais presentes"
        echo "  ✅ MCP Server executável"
        echo ""
        echo "🚀 Pronto para merge! 🥑" 