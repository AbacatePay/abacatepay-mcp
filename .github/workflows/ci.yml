name: CI - VerificaÃ§Ãµes de Qualidade

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    name: âœ… VerificaÃ§Ãµes ObrigatÃ³rias
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: ğŸ“¦ Instalar dependÃªncias
      run: bun install

    - name: ğŸ” Auditoria de seguranÃ§a
      run: |
        echo "ğŸ” Verificando vulnerabilidades de seguranÃ§a..."
        bun audit
        if [ $? -ne 0 ]; then
          echo "âŒ Vulnerabilidades de alta severidade encontradas!"
          echo "ğŸ’¡ Execute 'bun audit' para verificar detalhes"
          exit 1
        fi
        echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"

    - name: ğŸ§¹ VerificaÃ§Ã£o de cÃ³digo (ESLint)
      run: |
        echo "ğŸ§¹ Verificando qualidade do cÃ³digo..."
        bun run lint
        if [ $? -ne 0 ]; then
          echo "âŒ Problemas de qualidade de cÃ³digo encontrados!"
          echo "ğŸ’¡ Execute 'bun run lint:fix' para corrigir automaticamente"
          exit 1
        fi
        echo "âœ… CÃ³digo estÃ¡ seguindo os padrÃµes de qualidade"

    - name: ğŸ”§ VerificaÃ§Ã£o de tipos TypeScript
      run: |
        echo "ğŸ”§ Verificando tipos TypeScript..."
        bunx tsc --noEmit
        if [ $? -ne 0 ]; then
          echo "âŒ Erros de tipo encontrados!"
          echo "ğŸ’¡ Corrija os erros de TypeScript antes de continuar"
          exit 1
        fi
        echo "âœ… Todos os tipos estÃ£o corretos"

    - name: ğŸ§ª VerificaÃ§Ã£o do script inspector
      run: |
        echo "ğŸ§ª Testando script inspector..."
        if [ ! -f "scripts/inspector.js" ]; then
          echo "âŒ Script inspector nÃ£o encontrado!"
          exit 1
        fi
        
        # Verifica sintaxe do script
        bun scripts/inspector.js --help
        if [ $? -ne 0 ]; then
          echo "âŒ Script inspector tem erros de sintaxe!"
          exit 1
        fi
        
        echo "âœ… Script inspector estÃ¡ funcionando corretamente"

    - name: ğŸ” VerificaÃ§Ã£o de arquivos essenciais
      run: |
        echo "ğŸ” Verificando arquivos essenciais..."
        
        # Verifica se os arquivos TypeScript principais existem
        if [ ! -f "src/index.ts" ]; then
          echo "âŒ Arquivo principal nÃ£o encontrado!"
          exit 1
        fi
        
        # Verifica se o package.json tem os scripts necessÃ¡rios
        if ! grep -q '"start"' package.json || ! grep -q '"inspector"' package.json; then
          echo "âŒ Scripts bun essenciais nÃ£o encontrados!"
          echo "ğŸ“‹ Scripts necessÃ¡rios: start, inspector"
          exit 1
        fi
        
        echo "âœ… Todos os arquivos essenciais estÃ£o presentes"

    - name: ğŸ¯ Teste de importaÃ§Ã£o do MCP Server
      run: |
        echo "ğŸ¯ Testando se o MCP Server pode ser executado..."
        bun run src/index.ts --help
        if [ $? -ne 0 ]; then
          echo "âŒ Falha ao executar MCP Server!"
          exit 1
        fi
        echo "âœ… MCP Server executado com sucesso"

    - name: ğŸ‰ Sucesso
      run: |
        echo ""
        echo "ğŸ‰ Todas as verificaÃ§Ãµes passaram com sucesso!"
        echo ""
        echo "ğŸ“‹ Resumo das verificaÃ§Ãµes:"
        echo "  âœ… DependÃªncias instaladas"
        echo "  âœ… SeguranÃ§a verificada"
        echo "  âœ… Qualidade de cÃ³digo aprovada"
        echo "  âœ… Tipos TypeScript corretos"
        echo "  âœ… Script inspector funcional"
        echo "  âœ… Arquivos essenciais presentes"
        echo "  âœ… MCP Server executÃ¡vel"
        echo ""
        echo "ğŸš€ Pronto para merge! ğŸ¥‘" 